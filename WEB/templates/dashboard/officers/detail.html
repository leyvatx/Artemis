{% extends 'main.html' %}{% load static %}

{% block stylesheet %}
<link href='{% static "css/dashboard/officer.css" %}' rel='stylesheet' />
{% endblock stylesheet %}

{% block scripts %}
<script src='https://code.highcharts.com/highcharts.js'></script>
<script src='https://code.highcharts.com/highcharts-more.js'></script>
{% endblock scripts %}

{% block title %}Oficial: {{ officer.name }}{% endblock title %}

{% block content %}
<div class='dashboard-container'>
    <div class='detail-container'>

        <!-- Información general -->
        <section class='officer-info'>
            <div class='info-left'>

                {% if officer.picture %}
                <img class='officer-picture' src='{{ officer.picture }}' alt='Foto del oficial: {{ officer.name }}'>
                {% else %}
                <img class='officer-picture' src='{% static "images/unknown.jpeg" %}' alt='Oficial: {{ officer.name }}'>
                {% endif %}

            </div>

            <div class='info-right'>
                <h1 class='officer-name'>{{ officer.name }}</h1>
                <span class='officer-rank'>{{ officer.rank|capfirst }}</span>

                <div class='officer-status {{ officer.status|lower }}'>
                    {{ officer.status_label }}
                </div>

                <div class='officer-badge'>
                    <strong>Placa:</strong> {{ officer.badge_number }}
                </div>
            </div>
        </section>

        <!-- Datos biométricos -->
        <section class='biometrics-section'>
            <h2>Datos biométricos</h2>

            <div class='biometrics-grid'>
                <div class='chart-card'>
                    <div class='chart-title'>
                        <h4>Frecuencia cardíaca (BPM)</h4>
                        <strong class='bpm-number' id='currentBPMDisplay'>— BPM</strong>
                    </div>

                    <div id='bpmChart' class='bpm-chart'></div>

                    <div class='chart-indicators'>
                        <span class='indicator-low'>Reposo</span>
                        <span class='indicator-normal'>Normal</span>
                        <span class='indicator-moderate'>Moderado</span>
                        <span class='indicator-high'>Intenso</span>
                        <span class='indicator-risk'>En riesgo</span>
                    </div>
                </div>

                <div class='chart-card'>
                    <div class='chart-title'>
                        <h4>Nivel de estrés</h4>
                    </div>

                    <div id='stressChart'></div>
                </div>
            </div>
        </section>

        <!-- Reportes -->
        <section class='reports-section'>
            <h2>Reportes</h2>

            {% for report in reports %}
                <a href='{% url "dashboard:ReportDetail" report.report_id %}' class='report-link'>
                    <strong>{{ report.title }}</strong> ({{ report.report_type }}) - {{ report.status }}
                    <p>{{ report.summary }}</p>
                </a>
            {% empty %}
                <div class='placeholder'>No se ha reportado ninguna incidencia.</div>
            {% endfor %}
        </section>
    </div>
</div>


<script>
    /* CONFIGURACIÓN -------------------------------------------------------- */

    const INTERVAL_MS = 5000;
    const WINDOW_POINTS = 20;
    const STRESS_WINDOW = 10;

    const BASELINE_MAX = 150;
    const MULTIPLIER = 1.4;
    const MIN_ALLOWED_MAX = 100;
    const MAX_ALLOWED_MAX = 600;

    /* GENERADORES DE SEMILLA ------------------------------------------------------ */

    function randomWalk(seed, steps, stepSize = 3, min = 55, max = 140) {
        const arr = [];
        let v = seed;

        for (let i = 0; i < steps; i++) {
            v += (Math.random() - 0.5) * stepSize;
            v = Math.max(min, Math.min(max, v));
            arr.push(Math.round(v));
        }

        return arr;
    }

    function bpmColor(bpm) {
        if (bpm < 85) return '#2196F3';
        if (bpm < 110) return '#4CAF50';
        if (bpm < 135) return '#FFEB3B';
        if (bpm < 160) return '#FF9800';
        return '#E53935';
    }

    /* SEMILLAS ------------------------------------------------------------- */

    const now = Date.now();
    const initialStart = now - (WINDOW_POINTS - 1) * INTERVAL_MS;

    let seededBpm = [];
    let stressSeedValues = [];

    if ("{{ officer.id }}" != 2) {
        const bpmSeedValues = randomWalk(80, WINDOW_POINTS);

        seededBpm = bpmSeedValues.map((y, i) => ({
            x: initialStart + i * INTERVAL_MS, y, color: bpmColor(y) }));

        stressSeedValues = randomWalk(35, STRESS_WINDOW, 6, 5, 85);
    }

    /* CHART: BPM ----------------------------------------------------------- */

    const bpmChart = Highcharts.chart("bpmChart", {

        chart: {
            type: 'column', backgroundColor: 'transparent',
            height: 420, marginBottom: 50, animation: true,
            style: { fontFamily: 'inherit', color: 'inherit' },
        },

        title: { text: null },
        legend: { enabled: false },

        xAxis: {
            type: 'datetime',
            min: initialStart, max: now,
            tickPixelInterval: 80,
            ordinal: false,

            gridLineWidth: 0,
            startOnTick: false, endOnTick: false,

            labels: {
                formatter: function () {
                    return Highcharts.dateFormat('%H:%M:%S', this.value);
                }, style: { fontSize: '12px', color: '#445D5D' }
            }
        },

        yAxis: {
            gridLineWidth: 0,
            title: { text: null },
            min: 0, max: BASELINE_MAX,
            labels: { style: { fontSize: '12px', color: '#445D5D' } }
        },

        tooltip: {
            shared: false,
            pointFormatter: function () {
                const formattedTime = Highcharts.dateFormat('%a, %H:%M:%S', this.x);
                return `<b>${formattedTime}</b><br/>Ritmo cardíaco: <b>${Math.round(this.y)} BPM</b>`;
            },

            dateTimeLabelFormats: {
                millisecond: '%H:%M:%S.%L',
                second: '%H:%M:%S', minute: '%H:%M',
                hour: '%H:%M', day: '%e. %b. %Y',
                week: '%e. %b', month: '%b. %y', year: '%Y'
            }
        },

        plotOptions: {
            column: {
                pointPadding: 0,
                groupPadding: 0,
                borderWidth: 0,
                pointWidth: 8,
                animation: { duration: 220, easing: 'easeOutQuad' }
            },
            series: {
                states: { hover: { enabled: false } },
                turboThreshold: 0
            }
        },

        series: [{ name: 'BPM', type: 'column', data: seededBpm }],
        credits: { enabled: false }
    });

    /* CHART: STRESS -------------------------------------------------------- */

    const stressChart = Highcharts.chart("stressChart", {
        chart: {
            type: 'gauge', backgroundColor: 'transparent',
            height: '90%', animation: { duration: 300 },
            style: { fontFamily: 'inherit', color: 'inherit' },
        }, title: { text: null },
        
        pane: {
            startAngle: -140,
            endAngle: 140,

            background: [{
                backgroundColor: 'transparent',
                borderWidth: 0, outerRadius: '100%'
            }]
        },

        yAxis: {
            min: 0, max: 100,
            tickPosition: 'outside',
            tickColor: '#445D5D',
            minorTickInterval: null,
            tickLength: 6, tickWidth: 1,

            labels: {
                distance: 24,
                style: { color: '#445D5D', fontSize: '12px' }
            }, title: { text: null },

            plotBands: [
                { from: 0, to: 30, color: 'rgba(76, 175, 80, .4)' },
                { from: 30, to: 60, color: 'rgba(255, 235, 59, .4' },
                { from: 60, to: 85, color: 'rgba(255, 152, 0, .4)' },
                { from: 85, to: 100, color: 'rgba(229, 57, 53, .4)' }
            ]
        },

        plotOptions: {
            gauge: {
                dial: {
                    radius: '80%',
                    backgroundColor: '#445D5D',
                    baseWidth: 6, topWidth: 1,
                    baseLength: '20%',
                    rearLength: '-20%'
                },
                pivot: {
                    radius: 0, borderWidth: 0,
                    backgroundColor: 'transparent',
                }
            }, series: { animation: { duration: 300 } }
        },

        series: [
            {
                name: 'Estrés', tooltip: { enabled: false },
                data: [ stressSeedValues.length ? stressSeedValues[stressSeedValues.length - 1] : 0 ],

                dataLabels: {
                    useHTML: true,

                    formatter: function () {
                        const v = Math.round(this.y);
                        const color = (v < 30) ? '#4CAF50' : (v < 60) ? '#FFEB3B' : (v < 85) ? '#FF9800' : '#E53935';

                        return `<div style="text-align:center">
                            <div style="font-size:28px; font-weight:600; color:${color}; line-height:1">${v}</div>
                            <div style="font-size:11px; color:#445D5D; margin-top:2px">Nivel</div>
                            </div>`; 
                    }, borderWidth: 0, y: 0
                }
            }
        ],

        credits: { enabled: false }
    });

    /* ACTUALIZADORES ------------------------------------------------------- */

    function shiftStress(label, value) {
        const point = stressChart.series[0].points[0];
        point.update(value, true);
    }

    function adjustYAxisDynamic(currentBpm) {
        const series = bpmChart.series[0];
        const values = series.data.map(p => p.y).concat(currentBpm);

        const recentMax = Math.max(...values);
        let targetMax = Math.max(BASELINE_MAX, Math.ceil(recentMax * MULTIPLIER));
        targetMax = Math.min(Math.max(targetMax, MIN_ALLOWED_MAX), MAX_ALLOWED_MAX);

        bpmChart.yAxis[0].update({ max: targetMax });
    }

    /* FUNCIÓN CENTRAL: updateCharts() -------------------------------------- */

    // variable global para recordar el último timestamp procesado
    let lastCreatedAt = null;

    function updateCharts(currentBpm, stress, createdAt = null, fromApi = true) {
        let currentTime = createdAt ? new Date(createdAt).getTime() : Date.now();
        if (isNaN(currentTime)) currentTime = Date.now();

        if (fromApi) {
            if (lastCreatedAt === currentTime) {
                return; // Evita duplicados.
            }

            lastCreatedAt = currentTime;
        }

        const series = bpmChart.series[0];
        const color = bpmColor(currentBpm);

        adjustYAxisDynamic(currentBpm);
        bpmChart.xAxis[0].setExtremes(
            currentTime - (WINDOW_POINTS - 1) * INTERVAL_MS,
            currentTime, false
        );

        const shouldShift = series.data.length >= WINDOW_POINTS;
        series.addPoint({ x: currentTime, y: currentBpm, color }, true, shouldShift);

        // BPM actual:
        document.getElementById("currentBPMDisplay").innerText = currentBpm + " BPM";

        // Estrés actual:
        shiftStress(new Date(currentTime).toLocaleTimeString(), stress);
    }

    /* VALOR INICIAL DEL DISPLAY -------------------------------------------- */

    document.addEventListener("DOMContentLoaded", () => {
        if ("{{ officer.id }}" != 2) {
            const last = seededBpm[seededBpm.length - 1];
            document.getElementById("currentBPMDisplay").innerText = `${last.y} BPM`;
        }
    });

    /* PETICIÓN AL API ------------------------------------------------------ */

    const BIOMETRICS_URL = "{% url 'dashboard:OfficerBiometrics' %}";
    const officerId = "{{ officer.id }}";


    setInterval(() => {
        fetch(`${BIOMETRICS_URL}?officer=${officerId}`)
            .then(res => res.json())
            .then(data => {
                if (data.bpm !== undefined && data.stress !== undefined) {
                    updateCharts(data.bpm, data.stress, data.created_at, true);
                }
            })
            .catch(err => console.error("Error biométrico: ", err));
    }, INTERVAL_MS);
</script>

{% endblock %}